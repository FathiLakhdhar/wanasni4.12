{% extends ':Trajet:layout.html.twig' %}

{% block title %}Voir Trajet{% endblock title %}

{% block body %}

    <div class="container">

        {% if trajet %}

            <div class="row">
                <div class="col-md-8 ">
                    <div class="thumbnail">

                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <h3 class="panel-title">
                                    {{ trajet.origine.lieu }}
                                    <i class="ion ion-android-arrow-forward"></i>
                                    {{ trajet.destination.lieu }}
                                </h3>
                            </div>
                            <div class="panel-body">

                                <div class="row">
                                    <div class="col-md-6">

                                        {{ trajet.proposerAt|date("F jS \\a\\t g:ia") }}


                                        <ul class="alert alert-info">
                                        {%  for segment in trajet.segments %}
                                            <li>
                                                {{ segment.start.lieu }} <i class="ion ion-android-arrow-forward"></i> {{ segment.end.lieu }}
                                                <ul>
                                                    <li> {{ segment.distance }}   </li>
                                                    <li> {{ segment.duration }}   </li>
                                                    <li> {{ segment.prix }} TND  </li>
                                                </ul>
                                            </li>
                                        {% endfor %}
                                        </ul>




                                    </div>

                                    <div class="col-md-6">

                                        {% set strDateAller= trajet.datesAllerToArray|join('|') %}
                                        {% set strDateRetour= trajet.datesRetourToArray|join('|') %}
                                        <div id="widgetCalendar" data-date-Aller="{{ strDateAller }}"
                                             data-date-Retour="{{ strDateRetour }}" data-date-format="yy-mm-dd"
                                             class="ll-skin-melon">
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="legend-container">
                                                    <i class="legend green" aria-hidden="true"></i>
                                                    <span class="legend-green-label">Mes allers</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="legend-container">
                                                    <i class="legend blue" aria-hidden="true"></i>
                                                    <span class="legend-blue-label">Mes retours</span>
                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                </div>

                            </div>
                        </div>


                    </div>
                </div>
                <div class="col-md-4">
                    <div class="thumbnail">
                        <h3 class="steelblue">Votre itin√©raire</h3>

                        {% set strPointOrigine= trajet.origine.lieu %}
                        {% set strPointDestination= trajet.destination.lieu %}
                        {% set strPointWaypoints = '' %}
                        {% for waypoint in trajet.waypoints %}
                            {% if loop.first %}
                                {% set strPointWaypoints = waypoint.lieu %}
                            {% else %}
                                {% set strPointWaypoints = strPointWaypoints ~'|'~ waypoint.lieu %}
                            {% endif %}
                        {% endfor %}


                        {{ strPointWaypoints }}

                        <div id="map" data-Origine="{{ strPointOrigine }}" data-Destination="{{ strPointDestination }}"
                             data-Waypoints="{{ strPointWaypoints }}"></div>
                    </div>
                    <div class="thumbnail">
                        <div id="directions-panel"></div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="alert alert-warning">
                Trajet Not Found :/
            </div>

        {% endif %}


    </div>

{% endblock body %}

{% block javascripts %}


    {{ parent() }}


    <script>
        $(document).ready(function () {

            hasDate = function (typeDate, dateKey) {
                var dates = typeDate === "simple" ? widgetCalendar.data('date-aller').toString() : widgetCalendar.data('date-retour').toString();
                console.log(dates);
                return dates.includes(dateKey);
            };

            getDateKey = function (date) {
                return $.datepicker.formatDate("yymmdd", date)
            };


            beforeShowDay = function (date) {
                var dateCalendarKey = getDateKey(date), dateCalendarClass = "";
                if (hasDate("simple", dateCalendarKey)) {
                    dateCalendarClass += "simple-date-selected"
                }
                if (hasDate("round", dateCalendarKey)) {
                    dateCalendarClass += " round-date-selected"
                }
                return [true, dateCalendarClass]
            };

            var widgetCalendar = $("#widgetCalendar");
            widgetCalendar.datepicker({
                beforeShowDay: beforeShowDay
            });


        });
    </script>





    <script>
        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var map = new google.maps.Map(document.getElementById('map'), {
                center: new google.maps.LatLng(33.7774359, 9.4269145),
                zoom: 6,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                panControl: false,
                zoomControl: false,
                streetViewControl: false
            });
            directionsDisplay.setMap(map);

            calculateAndDisplayRoute(directionsService, directionsDisplay);
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
            var waypts = [];

            var $map = $('#map');

            var $Arraywaypts = [];
            $Arraywaypts = $map.data('waypoints').split('|');
            $.each($Arraywaypts, function (i, val) {
                console.log(val);
                waypts.push({
                    location: val,
                    stopover: true
                });
            });

            directionsService.route({
                origin: $map.data('origine'),
                destination: $map.data('destination'),
                waypoints: waypts,
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING
            }, function (response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    var route = response.routes[0];
                    var summaryPanel = document.getElementById('directions-panel');
                    summaryPanel.innerHTML = '';
                    // For each route, display summary information.
                    for (var i = 0; i < route.legs.length; i++) {
                        var routeSegment = i + 1;
                        summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
                                '</b><br>';
                        summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
                        summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
                        summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
                    }
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

    </script>


    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBk9B9hwksRr8Sr0LGF-uj0GtDZlKCw1r4&signed_in=true&libraries=places&callback=initMap"
            async defer></script>

{% endblock javascripts %}